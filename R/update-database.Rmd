---
title: IUCN Red List of Ecosystem assessment for the forest macrogroups of the Americas
subtitle: Upload tables to postgres database
author: JR Ferrer-Paris
---

# Tables for the IUCN RLE assessment

We will add information on the assessment in a table

```sql

CREATE TABLE ivc_assessment (
   mg_key character varying(4),
   country text,
   ref_code text,
   assessment_date date,
   a1 text[],
   a2b text[],
   a3  text[],
   b1 text[],
   b2 text[],
   b3  text[],
   b_conds text[],
   c2a  text[],
   c2b  text[],
   d1 text[],
   d2b text[],
   d3 text[],
   category  text[],
   threat_criteria text[],

   CONSTRAINT asmcode PRIMARY KEY (mg_key,country,assessment_date)
);


ALTER TABLE ivc_assessment
  ADD CONSTRAINT mg_fkey
  FOREIGN KEY (mg_key)
  REFERENCES ivc_americas(mg_key)
  ON DELETE CASCADE ON UPDATE CASCADE;

```

We source these files to set up the database connection information:

```{r}
source $HOME/proyectos/IUCN/RLE-forests-panam-results/env/project-env.sh

```

For all criteria we will include best estimates and plausible bounds as an array. Best estimate is always the first value.

```{r}
#!R --vanilla
require(dplyr)
library(tidyr)
require(magrittr)
require(RPostgreSQL)

source("~/proyectos/IUCN/RLE-forests-panam-results/env/project-env.R")


## working directory and path to scripts
script.dir <- Sys.getenv("SCRIPTDIR")
setwd(script.dir)

drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = Sys.getenv("DBNAME"),
                 host = Sys.getenv("DBHOST"),
                 port = Sys.getenv("DBPORT"),
                 user = Sys.getenv("DBUSER"))

## Assessment outcomes
load(sprintf("%s/Rdata/20181123_MacrogroupsCountry.rda", script.dir))

 Macrogroups.Global %>%transmute(
    mg_key=IVC.macrogroup_key,
    country=Country,
    a1=sprintf("'{%s}'",ifelse(is.na(bounds.A1),A1,
    paste(A1,gsub(" -- ",",",bounds.A1),sep=","))),
    a2b=sprintf("'{%s}'",ifelse(is.na(bounds.A2b),A2b,
    paste(A2b,gsub(" -- ",",",bounds.A2b),sep=","))),
    a3=sprintf("'{%s}'",ifelse(is.na(bounds.A3),A3,
    paste(A3,gsub(" -- ",",",bounds.A3),sep=","))),
    b1=sprintf("'{%s}'",B1),b2=sprintf("'{%s}'",B1),b3=sprintf("'{%s}'",B1),
    c2a=sprintf("'{%s}'",ifelse(is.na(bounds.C2a),C2a,
    paste(C2a,gsub("--",",",bounds.C2a),sep=","))),
    c2b=sprintf("'{%s}'",C2b),
   d1=sprintf("'{%s}'",D1),
    d2b=sprintf("'{%s}'",D2b),
    d3=sprintf("'{%s}'",D3),
    category=sprintf("'{%s}'",ifelse(is.na(Overall.Bounds),Overall.Category,
    paste(Overall.Category,gsub(" -- ",",",Overall.Bounds),sep=","))),
    threat_criteria=ifelse(is.na(Threat.criteria),"NULL",sprintf("'{%s}'", Threat.criteria))) -> Assessment

qry <- sprintf("INSERT INTO ivc_assessment (mg_key,country,ref_code,assessment_date,a1,a2b,a3,b1,b2,b3,c2a,c2b,d1,d2b,d3,category,threat_criteria) values %s",
   paste( with(Assessment,sprintf("('%s','%s','Ferrer-Paris et al. 2019','2018-12-01',%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)",mg_key,country,a1,a2b,a3,b1,b2,b3,c2a,c2b,d1,d2b,d3,category,threat_criteria)),collapse=","))

dbSendQuery(con,qry)


 Macrogroups.Country %>%transmute(
    mg_key=IVC.macrogroup_key,
    country=Country,
    a1=sprintf("'{%s}'",ifelse(is.na(bounds.A1),A1,
    paste(A1,gsub(" -- ",",",bounds.A1),sep=","))),
    a2b=sprintf("'{%s}'",ifelse(is.na(bounds.A2b),A2b,
    paste(A2b,gsub(" -- ",",",bounds.A2b),sep=","))),
    a3=sprintf("'{%s}'",ifelse(is.na(bounds.A3),A3,
    paste(A3,gsub(" -- ",",",bounds.A3),sep=","))),
    b1=sprintf("'{%s}'",B1),b2=sprintf("'{%s}'",B1),b3=sprintf("'{%s}'",B1),
    c2a=sprintf("'{%s}'",ifelse(is.na(bounds.C2a),C2a,
    paste(C2a,gsub("--",",",bounds.C2a),sep=","))),
    c2b=sprintf("'{%s}'",C2b),
   d1=sprintf("'{%s}'",D1),
    d2b=sprintf("'{%s}'",D2b),
    d3=sprintf("'{%s}'",D3),
    category=sprintf("'{%s}'",ifelse(is.na(Overall.Bounds),Overall.Category,
    paste(Overall.Category,gsub(" -- ",",",Overall.Bounds),sep=","))),
    threat_criteria=ifelse(is.na(Threat.criteria),"NULL",sprintf("'{%s}'", Threat.criteria))) -> Assessment

qry <- sprintf("INSERT INTO ivc_assessment (mg_key,country,ref_code,assessment_date,a1,a2b,a3,b1,b2,b3,c2a,c2b,d1,d2b,d3,category,threat_criteria) values %s",
   paste( with(Assessment,sprintf("('%s','%s','Ferrer-Paris et al. 2019','2018-12-01',%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)",mg_key,country,a1,a2b,a3,b1,b2,b3,c2a,c2b,d1,d2b,d3,category,threat_criteria)),collapse=","))

dbSendQuery(con,qry)


dbDisconnect(con)


```

Replicate these values to be updated later
```sql

INSERT INTO ivc_assessment
SELECT mg_key,country,'Imperiled, MS','2021-04-01',a1,a2b,a3,b1,b2,b3,b_conds,c2a,c2b,d1,d2b,d3,category,threat_criteria FROM ivc_assessment where country='global' AND ref_code='Ferrer-Paris et al. 2019'
```
